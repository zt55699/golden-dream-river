<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather.gc.ca Parser Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <h1 class="text-2xl font-bold mb-4">Weather.gc.ca Data Parser Test</h1>
    
    <div class="space-y-4">
        <button onclick="fetchDirectly()" class="bg-blue-500 text-white px-4 py-2 rounded">
            Test Direct Fetch (will fail due to CORS)
        </button>
        
        <button onclick="fetchWithProxy()" class="bg-green-500 text-white px-4 py-2 rounded">
            Test with CORS Proxy
        </button>
        
        <button onclick="fetchWithDifferentProxy()" class="bg-purple-500 text-white px-4 py-2 rounded">
            Test with cors-anywhere Proxy
        </button>
    </div>
    
    <div id="status" class="mt-4 p-4 bg-white rounded shadow"></div>
    <div id="raw" class="mt-4 p-4 bg-gray-200 rounded shadow text-xs overflow-auto max-h-96"></div>
    <div id="parsed" class="mt-4 p-4 bg-white rounded shadow"></div>
    
    <script>
        async function fetchDirectly() {
            const status = document.getElementById('status');
            const raw = document.getElementById('raw');
            const parsed = document.getElementById('parsed');
            
            status.innerHTML = 'Fetching directly from weather.gc.ca...';
            
            try {
                const response = await fetch('https://weather.gc.ca/en/location/index.html?coords=50.117,-122.955');
                const text = await response.text();
                
                status.innerHTML = '✅ Success! Got response';
                raw.innerHTML = `<pre>${text.substring(0, 2000)}...</pre>`;
                parseWeatherData(text);
            } catch (error) {
                status.innerHTML = `❌ Failed (expected due to CORS): ${error.message}`;
                raw.innerHTML = '';
                parsed.innerHTML = '';
            }
        }
        
        async function fetchWithProxy() {
            const status = document.getElementById('status');
            const raw = document.getElementById('raw');
            const parsed = document.getElementById('parsed');
            
            status.innerHTML = 'Fetching with allorigins proxy...';
            
            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = encodeURIComponent('https://weather.gc.ca/en/location/index.html?coords=50.117,-122.955');
                
                const response = await fetch(proxyUrl + targetUrl);
                const data = await response.json();
                const html = data.contents;
                
                status.innerHTML = '✅ Success with proxy! Got response';
                raw.innerHTML = `<pre>${html.substring(0, 2000)}...</pre>`;
                parseWeatherData(html);
            } catch (error) {
                status.innerHTML = `❌ Failed with proxy: ${error.message}`;
                raw.innerHTML = '';
                parsed.innerHTML = '';
            }
        }
        
        async function fetchWithDifferentProxy() {
            const status = document.getElementById('status');
            const raw = document.getElementById('raw');
            const parsed = document.getElementById('parsed');
            
            status.innerHTML = 'Fetching with corsproxy.io...';
            
            try {
                const proxyUrl = 'https://corsproxy.io/?';
                const targetUrl = encodeURIComponent('https://weather.gc.ca/en/location/index.html?coords=50.117,-122.955');
                
                const response = await fetch(proxyUrl + targetUrl);
                const html = await response.text();
                
                status.innerHTML = '✅ Success with corsproxy! Got response';
                raw.innerHTML = `<pre>${html.substring(0, 2000)}...</pre>`;
                parseWeatherData(html);
            } catch (error) {
                status.innerHTML = `❌ Failed with corsproxy: ${error.message}`;
                raw.innerHTML = '';
                parsed.innerHTML = '';
            }
        }
        
        function parseWeatherData(html) {
            const parsed = document.getElementById('parsed');
            
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Try multiple selectors to find weather data
                const selectors = {
                    currentTemp: [
                        '.wxo-metric-hide',
                        '.temperature',
                        '[data-temperature]',
                        '.current-temp',
                        '.temp-current',
                        '.wxo-city-current-temperature',
                        '.current-conditions .temperature',
                        '.wxo-current-temp'
                    ],
                    currentCondition: [
                        '.mrgn-tp-md',
                        '.condition',
                        '.weather-condition',
                        '.current-condition',
                        '.wxo-city-current-summary',
                        '[data-condition]'
                    ],
                    forecast: [
                        '.div-table',
                        '.forecast-day',
                        '.daily-forecast',
                        '.wxo-forecast',
                        '.seven-days-group',
                        '.day-forecast'
                    ]
                };
                
                let results = '<h3 class="font-bold mb-2">Parsed Results:</h3>';
                results += '<div class="space-y-2">';
                
                // Try to find current temperature
                results += '<h4 class="font-semibold">Current Temperature:</h4>';
                let tempFound = false;
                for (const selector of selectors.currentTemp) {
                    const elem = doc.querySelector(selector);
                    if (elem) {
                        results += `<div class="text-green-600">Found with "${selector}": ${elem.textContent.trim()}</div>`;
                        tempFound = true;
                        break;
                    }
                }
                if (!tempFound) {
                    // Try finding any element containing °C
                    const allElements = doc.querySelectorAll('*');
                    for (const elem of allElements) {
                        if (elem.textContent && elem.textContent.includes('°C') && elem.textContent.length < 20) {
                            results += `<div class="text-orange-600">Found temperature text in ${elem.tagName}.${elem.className}: ${elem.textContent.trim()}</div>`;
                            tempFound = true;
                            break;
                        }
                    }
                }
                if (!tempFound) {
                    results += '<div class="text-red-600">No temperature found</div>';
                }
                
                // Try to find current condition
                results += '<h4 class="font-semibold mt-4">Current Condition:</h4>';
                for (const selector of selectors.currentCondition) {
                    const elem = doc.querySelector(selector);
                    if (elem) {
                        results += `<div class="text-green-600">Found with "${selector}": ${elem.textContent.trim()}</div>`;
                        break;
                    }
                }
                
                // Debug: Test the improved condition extraction
                results += '<h4 class="font-semibold mt-4">Improved Condition Extraction:</h4>';
                const conditionSelectors = ['.wxo-conds-col2', '.wxo-conds-col3', '.wxo-detailsconds', '.textforecast'];
                
                for (const selector of conditionSelectors) {
                    const elements = doc.querySelectorAll(selector);
                    for (const elem of elements) {
                        const text = elem.textContent.trim();
                        results += `<div class="text-blue-600">Testing "${selector}": "${text.substring(0, 50)}..."</div>`;
                        if (text && 
                            !text.includes('°C') && 
                            !text.includes('°F') &&
                            !text.includes('%') && 
                            !text.match(/^\d+$/) &&
                            text.length > 3 && 
                            text.length < 100 &&
                            !text.includes('Observed at') &&
                            !text.includes('Date:')) {
                            results += `<div class="text-green-600">✓ Valid condition found: "${text}"</div>`;
                            break;
                        }
                    }
                }
                
                // Test improved forecast extraction for current condition
                results += '<h4 class="font-semibold mt-4">Improved Forecast-based Condition:</h4>';
                
                // Try textforecast detailed condition first
                const textForecastElement = doc.querySelector('.textforecast');
                if (textForecastElement) {
                    const forecastText = textForecastElement.textContent.trim();
                    results += `<div class="text-blue-600">TextForecast content: "${forecastText.substring(0, 100)}..."</div>`;
                    const tonightDetailMatch = forecastText.match(/Tonight([A-Za-z\s\.]+?)(?:\d+\s*percent|\.|$)/i);
                    if (tonightDetailMatch && tonightDetailMatch[1]) {
                        results += `<div class="text-green-600">✓ From detailed forecast: "${tonightDetailMatch[1].trim()}"</div>`;
                    }
                }
                
                // Try div-table summary
                const forecastDiv = doc.querySelector('.div-table');
                if (forecastDiv) {
                    const forecastText = forecastDiv.textContent.trim();
                    results += `<div class="text-blue-600">Div-table content: "${forecastText.substring(0, 100)}..."</div>`;
                    const tonightMatch = forecastText.match(/Tonight\s+\d+°C\s*([A-Za-z\s]+?)(?:Fri|Sat|Sun|Mon|Tue|Wed|Thu|\d)/);
                    if (tonightMatch && tonightMatch[1]) {
                        results += `<div class="text-green-600">✓ From summary (improved): "${tonightMatch[1].trim()}"</div>`;
                    }
                }
                
                // Try to find forecast
                results += '<h4 class="font-semibold mt-4">Forecast Elements:</h4>';
                for (const selector of selectors.forecast) {
                    const elems = doc.querySelectorAll(selector);
                    if (elems.length > 0) {
                        results += `<div class="text-green-600">Found ${elems.length} elements with "${selector}"</div>`;
                        elems.forEach((elem, i) => {
                            if (i < 3) { // Show first 3
                                results += `<div class="ml-4 text-sm text-gray-600">${elem.textContent.trim().substring(0, 100)}...</div>`;
                            }
                        });
                        break;
                    }
                }
                
                // Look for any temperature-like text
                results += '<h4 class="font-semibold mt-4">Temperature patterns found:</h4>';
                const tempPattern = /-?\d+°C/g;
                const temps = html.match(tempPattern);
                if (temps) {
                    results += `<div class="text-blue-600">Found temperatures: ${temps.slice(0, 10).join(', ')}</div>`;
                }
                
                // Debug: Show some class names found
                results += '<h4 class="font-semibold mt-4">Common classes found:</h4>';
                const allElements = doc.querySelectorAll('[class]');
                const classes = new Set();
                allElements.forEach(elem => {
                    elem.classList.forEach(cls => {
                        if (cls.includes('wx') || cls.includes('temp') || cls.includes('forecast') || cls.includes('weather')) {
                            classes.add(cls);
                        }
                    });
                });
                results += `<div class="text-purple-600">${Array.from(classes).slice(0, 20).join(', ')}</div>`;
                
                results += '</div>';
                parsed.innerHTML = results;
                
            } catch (error) {
                parsed.innerHTML = `<div class="text-red-600">Parse error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>